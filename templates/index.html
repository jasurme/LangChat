<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    transitionTimingFunction: {
                        'apple': 'cubic-bezier(0.25, 1, 0.5, 1)',
                    }
                }
            }
        }
    </script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        /* Only styles impossible to do with Tailwind */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Markdown content — must be CSS since it targets rendered HTML from marked.js */
        .markdown-content {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #1c1917;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.15em;
        }

        .markdown-content p {
            margin-bottom: 1em;
            line-height: 1.7;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .markdown-content code {
            background: #f5f5f4;
            padding: 0.2em 0.4em;
            border-radius: 0.25rem;
            font-size: 0.9em;
            font-family: 'Monaco', 'Courier New', monospace;
            color: #dc2626;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .markdown-content pre {
            background: #1e1e1e;
            padding: 1em;
            border-radius: 0.5rem;
            overflow-x: auto;
            overflow-y: visible;
            margin: 1em 0;
            position: relative;
            max-width: 100%;
            box-sizing: border-box;
        }

        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: #d4d4d4;
            font-size: 0.875em;
            display: block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
            word-wrap: break-word;
            overflow-wrap: break-word

        .markdown-content pre code::-moz-selection {
            background-color: #0ea5e9;
            color: #ffffff;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
        }

        .markdown-content a {
            color: #2563eb;
            text-decoration: underline;
        }

        .markdown-content blockquote {
            border-left: 3px solid #d6d3d1;
            padding-left: 1em;
            color: #57534e;
            margin: 1em 0;
        }
    </style>
</head>

<body class="bg-[#fdfbf7] text-stone-800 font-sans h-screen flex flex-col overflow-hidden selection:bg-stone-200">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/70 z-[300] flex items-center justify-center opacity-100 pointer-events-auto transition-opacity duration-300">
        <div id="login-box" class="bg-white rounded-2xl p-8 max-w-[400px] w-[90%] shadow-2xl">
            <h2 class="text-2xl font-semibold text-stone-900 mb-2">Welcome to LangChat</h2>
            <p class="text-stone-500 text-sm mb-6">Enter a unique username to get started</p>
            <form id="login-form" onsubmit="handleLoginSubmit(event)">
                <input type="text" id="login-username" 
                    class="w-full border border-stone-300 text-stone-800 text-base rounded-lg px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-stone-500 focus:border-transparent transition-all placeholder:text-stone-400"
                    placeholder="Enter username..." autocomplete="off" required minlength="3">
                <div id="login-error" class="text-red-600 text-sm mb-4 h-5"></div>
                <button type="submit" class="w-full bg-stone-900 hover:bg-stone-700 text-white font-medium py-3 rounded-lg transition-colors mb-3">
                    Get Started
                </button>
            </form>
            <p class="text-xs text-stone-400 text-center">Your username identifies your chats. Choose something unique.</p>
        </div>
    </div>

    <!-- Top Header Bar -->
    <header
        class="fixed top-0 left-0 right-0 h-14 bg-white border-b border-stone-200 flex items-center justify-between px-4 z-50">
        <div class="flex items-center gap-3">
            <button id="sidebar-toggle" class="p-2 hover:bg-stone-100 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <h1 class="text-xl font-semibold tracking-tight text-stone-900">LangChat</h1>
        </div>
        <div class="flex items-center gap-3">
            <span id="username-display" class="text-sm text-stone-600 font-medium"></span>
            <button id="new-chat-btn"
                class="flex items-center gap-2 px-4 py-2 bg-stone-900 hover:bg-stone-700 text-white rounded-lg transition-colors text-sm font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                New Chat
            </button>
            <button id="logout-btn" class="px-3 py-2 text-stone-600 hover:bg-stone-100 rounded-lg transition-colors text-sm font-medium"
                title="Logout">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3h12.75" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed top-14 left-0 bottom-0 bg-[#1e1e1e] text-white w-[280px] overflow-hidden z-40 transition-all duration-300 ease-apple">
        <div class="h-full flex flex-col">
            <!-- Search Bar -->
            <div id="sidebar-content" class="p-4 transition-opacity duration-300">
                <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                    <input type="text" id="search-threads" placeholder="Search threads..."
                        class="w-full bg-[#2a2a2a] border border-[#3a3a3a] text-white text-sm rounded-lg pl-9 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-stone-500 placeholder:text-gray-500">
                </div>
            </div>

            <!-- Chat History -->
            <div id="chat-history"
                class="flex-1 overflow-y-auto no-scrollbar px-4 pb-4 transition-opacity duration-300">
                <div id="sessions-list" class="space-y-1">
                    <div class="text-center text-gray-500 text-[0.8rem] py-8 px-4 leading-relaxed" id="empty-msg">No
                        conversations yet.<br>Start a new chat!</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="main-content"
        class="h-screen flex flex-col pt-14 ml-[280px] transition-all duration-300 ease-apple relative overflow-hidden">

        <!-- Chat messages -->
        <div id="chat-container"
            class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden w-full max-w-3xl mx-auto px-4 pt-10 pb-40 opacity-0 transition-opacity duration-700 ease-apple no-scrollbar">
        </div>

        <!-- Hero section -->
        <div id="hero-section"
            class="absolute inset-0 flex flex-col items-center justify-center pb-48 transition-all duration-700 ease-apple z-0 mt-14">
            <div class="mb-60 text-center transition-opacity duration-500" id="hero-text">
                <h2 class="text-4xl font-semibold tracking-tight text-stone-900 mb-2">How can I help?</h2>
                <p class="text-stone-500">Ask anything.</p>
            </div>
        </div>

        <!-- Input area -->
        <div id="input-wrapper"
            class="absolute inset-0 flex items-center justify-center transition-all duration-700 ease-apple z-10 p-4 mt-14">
            <div class="w-full max-w-2xl relative">
                <form id="chat-form" class="relative group" onsubmit="handleMessage(event)">
                    <input type="text" id="user-input"
                        class="w-full bg-white border border-stone-200 text-stone-800 text-lg rounded-[2rem] px-6 py-4 shadow-[0_8px_30px_rgb(0,0,0,0.04)] focus:outline-none focus:ring-2 focus:ring-stone-200 focus:shadow-[0_8px_30px_rgb(0,0,0,0.08)] transition-all duration-300 placeholder:text-stone-400"
                        placeholder="ask..." autocomplete="off" maxlength="400">
                    <button type="submit"
                        class="absolute right-2 top-2 bottom-2 bg-stone-900 hover:bg-stone-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors duration-200 disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" />
                        </svg>
                    </button>
                </form>
                <div class="flex justify-between items-center mt-3 text-xs text-stone-400">
                    <div class="flex gap-4">
                        <span id="char-count">0 / 400</span>
                        <span id="messages-remaining" class="font-medium"></span>
                    </div>
                    <div id="char-warning" class="text-red-500 opacity-0 transition-opacity duration-200"></div>
                </div>
                <div class="text-center mt-4 text-xs text-stone-400 opacity-0 transition-opacity duration-700"
                    id="footer-text">Ask...</div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal"
        class="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="delete-modal-box"
            class="bg-[#2f2f2f] border border-[#424242] rounded-2xl p-6 max-w-[400px] w-[90%] scale-95 transition-transform duration-200">
            <h3 class="text-[#e5e7eb] text-lg font-semibold mb-3">Delete chat?</h3>
            <p class="text-[#9ca3af] text-sm leading-relaxed mb-5">This will delete <strong id="delete-modal-title"
                    class="text-[#e5e7eb]"></strong>.</p>
            <div class="flex justify-end gap-2">
                <button id="modal-cancel-btn"
                    class="px-5 py-2 rounded-lg text-sm font-medium bg-[#424242] text-[#e5e7eb] hover:bg-[#525252] transition-colors cursor-pointer">Cancel</button>
                <button id="modal-delete-btn"
                    class="px-5 py-2 rounded-lg text-sm font-medium bg-red-600 text-white hover:bg-red-700 transition-colors cursor-pointer">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let hasStarted = false;
        let sidebarExpanded = true;
        let currentSessionId = null;
        let sessionsCache = [];
        let activeDropdown = null;
        let pendingDeleteSessionId = null;
        let currentUsername = null;

        // ==================== DOM ELEMENTS ====================
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const loginUsername = document.getElementById('login-username');
        const loginError = document.getElementById('login-error');
        const usernameDisplay = document.getElementById('username-display');
        const logoutBtn = document.getElementById('logout-btn');
        
        const chatContainer = document.getElementById('chat-container');
        const heroSection = document.getElementById('hero-section');
        const heroText = document.getElementById('hero-text');
        const inputWrapper = document.getElementById('input-wrapper');
        const footerText = document.getElementById('footer-text');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const charCount = document.getElementById('char-count');
        const charWarning = document.getElementById('char-warning');
        const messagesRemaining = document.getElementById('messages-remaining');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const newChatBtn = document.getElementById('new-chat-btn');
        const sidebarContent = document.getElementById('sidebar-content');
        const chatHistoryEl = document.getElementById('chat-history');
        const sessionsList = document.getElementById('sessions-list');
        const deleteModal = document.getElementById('delete-modal');
        const deleteModalBox = document.getElementById('delete-modal-box');
        const deleteModalTitle = document.getElementById('delete-modal-title');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');

        // ==================== LOGIN MANAGEMENT ====================
        async function handleLoginSubmit(event) {
            event.preventDefault();
            const username = loginUsername.value.trim();
            
            // Frontend validation
            if (!username) {
                loginError.textContent = 'Username cannot be empty';
                loginUsername.focus();
                return;
            }
            
            if (username.length < 3) {
                loginError.textContent = 'Username must be at least 3 characters long';
                loginUsername.focus();
                return;
            }
            
            if (username.length > 50) {
                loginError.textContent = 'Username must be 50 characters or less';
                loginUsername.focus();
                return;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                loginError.textContent = 'Username can only contain letters, numbers, hyphens, and underscores';
                loginUsername.focus();
                return;
            }
            
            loginError.textContent = '';
            const btn = loginForm.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle error responses from backend
                    loginError.textContent = data.detail || data.message || 'Registration failed';
                    btn.disabled = false;
                    btn.textContent = 'Get Started';
                    return;
                }
                
                if (!data.success) {
                    loginError.textContent = data.message || 'Registration failed';
                    btn.disabled = false;
                    btn.textContent = 'Get Started';
                    return;
                }
                
                // Store username in localStorage
                localStorage.setItem('langhchat_username', username);
                currentUsername = username;
                
                // Hide login modal
                loginModal.classList.add('opacity-0', 'pointer-events-none');
                loginModal.style.display = 'none';
                
                // Update header
                usernameDisplay.textContent = `@${username}`;
                
                // Initialize character counter
                updateCharCount();
                
                // Focus on input
                setTimeout(() => userInput.focus(), 100);
                
            } catch (error) {
                loginError.textContent = 'Error: Unable to connect to server';
                console.error('Login error:', error);
                btn.disabled = false;
                btn.textContent = 'Get Started';
            }
        }
        
        function logout() {
            localStorage.removeItem('langhchat_username');
            currentUsername = null;
            location.reload();
        }
        
        // ==================== USERNAME VALIDATION ====================
        function validateUsername(username) {
            if (!username) {
                return { valid: false, message: 'Username cannot be empty' };
            }
            if (username.length < 3) {
                return { valid: false, message: `Username must be at least 3 characters (${username.length}/3)` };
            }
            if (username.length > 50) {
                return { valid: false, message: 'Username must be 50 characters or less' };
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                return { valid: false, message: 'Only letters, numbers, hyphens, and underscores allowed' };
            }
            return { valid: true, message: '✓ Username valid' };
        }
        
        // Real-time validation feedback
        loginUsername.addEventListener('input', (e) => {
            const username = e.target.value.trim();
            const validation = validateUsername(username);
            
            if (username === '') {
                loginError.textContent = '';
            } else {
                loginError.textContent = validation.message;
                loginError.className = validation.valid 
                    ? 'text-green-600 text-sm mb-4 h-5' 
                    : 'text-red-600 text-sm mb-4 h-5';
            }
            
            // Disable submit button if invalid
            const btn = loginForm.querySelector('button[type="submit"]');
            btn.disabled = !validation.valid || username === '';
        });
        
        function checkAuth() {
            const stored = localStorage.getItem('langhchat_username');
            if (stored) {
                currentUsername = stored;
                loginModal.style.display = 'none';
                loginModal.classList.add('opacity-0', 'pointer-events-none');
                usernameDisplay.textContent = `@${stored}`;
                loadRemainingMessages();
                return true;
            } else {
                loginModal.style.display = 'flex';
                loginModal.classList.remove('opacity-0', 'pointer-events-none');
                loginUsername.focus();
                return false;
            }
        }

        // ==================== LOAD REMAINING MESSAGES ====================
        async function loadRemainingMessages() {
            try {
                const url = new URL('/remaining_messages', window.location.origin);
                url.searchParams.append('username', currentUsername);
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                messagesRemaining.textContent = `${data.remaining} messages left today`;
                messagesRemaining.className = data.remaining <= 2 ? 'font-medium text-red-500' : 'text-stone-400';
            } catch (e) {
                console.error('Error loading remaining messages:', e);
            }
        }

        // ==================== CHARACTER COUNTER ====================
        function updateCharCount() {
            const len = userInput.value.trim().length;
            const submitBtn = chatForm.querySelector('button[type="submit"]');
            charCount.textContent = `${len} / 400`;
            
            // Disable submit button if message is empty or too long
            submitBtn.disabled = len === 0 || len > 400;
            
            if (len === 0) {
                charCount.classList.remove('text-orange-500', 'text-red-500');
                charWarning.classList.add('opacity-0');
            } else if (len > 350 && len <= 390) {
                charCount.classList.add('text-orange-500');
                charCount.classList.remove('text-red-500');
                charWarning.textContent = `${400 - len} chars left`;
                charWarning.classList.remove('opacity-0');
            } else if (len > 390) {
                charCount.classList.add('text-red-500');
                charCount.classList.remove('text-orange-500');
                charWarning.textContent = 'Nearly at limit!';
                charWarning.classList.remove('opacity-0');
            } else {
                charCount.classList.remove('text-orange-500', 'text-red-500');
                charWarning.classList.add('opacity-0');
            }
        }

        // ==================== UTILITY: UUID ====================
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // ==================== UTILITY: RELATIVE TIME ====================
        function relativeTime(isoString) {
            if (!isoString) return '';
            const diffMs = Date.now() - new Date(isoString);
            const mins = Math.floor(diffMs / 60000);
            const hrs = Math.floor(diffMs / 3600000);
            const days = Math.floor(diffMs / 86400000);
            if (mins < 1) return 'Just now';
            if (mins < 60) return `${mins}m ago`;
            if (hrs < 24) return `${hrs}h ago`;
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)}w ago`;
            return new Date(isoString).toLocaleDateString();
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str;
            return d.innerHTML;
        }

        // ==================== SIDEBAR: LOAD SESSIONS ====================
        async function loadSessions() {
            try {
                const url = new URL('/sessions', window.location.origin);
                url.searchParams.append('username', currentUsername);
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed');
                sessionsCache = await resp.json();
                renderSessions(sessionsCache);
            } catch (e) { console.error('Error loading sessions:', e); }
        }

        function renderSessions(sessions) {
            sessionsList.innerHTML = '';
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<div class="text-center text-gray-500 text-[0.8rem] py-8 px-4 leading-relaxed">No conversations yet.<br>Start a new chat!</div>';
                return;
            }

            sessions.forEach(session => {
                const item = document.createElement('div');
                const isActive = session.session_id === currentSessionId;
                item.className = `relative px-3 py-2 rounded-lg cursor-pointer transition-colors duration-200 group ${isActive ? 'bg-white/[0.08]' : 'hover:bg-white/[0.05]'}`;
                item.dataset.sessionId = session.session_id;

                const title = session.title.length > 50 ? session.title.substring(0, 50) + '…' : session.title;

                item.innerHTML = `
                    <div class="text-sm font-medium text-white truncate pr-7">${escapeHtml(title)}</div>
                    <div class="text-xs text-gray-400 mt-0.5">${relativeTime(session.last_active)}</div>
                    <button class="absolute right-1.5 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-white/10 text-gray-400 hover:text-gray-200 transition-all duration-150 menu-trigger" title="Options">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                        </svg>
                    </button>
                    <div class="dropdown-menu absolute right-0 top-full mt-1 bg-[#2f2f2f] border border-[#424242] rounded-xl p-1 min-w-[160px] z-[100] shadow-[0_8px_24px_rgba(0,0,0,0.4)] opacity-0 scale-95 -translate-y-1 pointer-events-none transition-all duration-150">
                        <button class="flex items-center gap-2.5 w-full px-3 py-2 rounded-md text-[0.85rem] text-red-400 hover:bg-red-500/10 transition-colors" data-action="delete">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 shrink-0">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                            </svg>
                            Delete
                        </button>
                    </div>
                `;

                // Click to load session
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.menu-trigger') || e.target.closest('.dropdown-menu')) return;
                    closeAllDropdowns();
                    loadSession(session.session_id);
                });

                // Three-dot menu
                const menuTrigger = item.querySelector('.menu-trigger');
                const dropdown = item.querySelector('.dropdown-menu');
                menuTrigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(menuTrigger, dropdown);
                });

                // Delete option
                item.querySelector('[data-action="delete"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeAllDropdowns();
                    showDeleteModal(session.session_id, title);
                });

                sessionsList.appendChild(item);
            });
        }

        // ==================== DROPDOWN LOGIC ====================
        function toggleDropdown(trigger, dropdown) {
            const isOpen = dropdown.classList.contains('show-dropdown');
            closeAllDropdowns();
            if (!isOpen) {
                dropdown.classList.add('show-dropdown');
                dropdown.classList.remove('opacity-0', 'scale-95', '-translate-y-1', 'pointer-events-none');
                dropdown.classList.add('opacity-100', 'scale-100', 'translate-y-0', 'pointer-events-auto');
                trigger.classList.add('!opacity-100');
                activeDropdown = { trigger, dropdown };
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-menu.show-dropdown').forEach(d => {
                d.classList.remove('show-dropdown', 'opacity-100', 'scale-100', 'translate-y-0', 'pointer-events-auto');
                d.classList.add('opacity-0', 'scale-95', '-translate-y-1', 'pointer-events-none');
            });
            document.querySelectorAll('.menu-trigger.\\!opacity-100').forEach(t => t.classList.remove('!opacity-100'));
            activeDropdown = null;
        }

        document.addEventListener('click', (e) => {
            if (activeDropdown && !e.target.closest('.menu-trigger') && !e.target.closest('.dropdown-menu')) {
                closeAllDropdowns();
            }
        });

        // ==================== DELETE CONFIRMATION MODAL ====================
        function showDeleteModal(sessionId, title) {
            pendingDeleteSessionId = sessionId;
            deleteModalTitle.textContent = title;
            deleteModal.classList.remove('opacity-0', 'pointer-events-none');
            deleteModal.classList.add('opacity-100', 'pointer-events-auto');
            deleteModalBox.classList.remove('scale-95');
            deleteModalBox.classList.add('scale-100');
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('opacity-100', 'pointer-events-auto');
            deleteModal.classList.add('opacity-0', 'pointer-events-none');
            deleteModalBox.classList.remove('scale-100');
            deleteModalBox.classList.add('scale-95');
            pendingDeleteSessionId = null;
        }

        modalCancelBtn.addEventListener('click', hideDeleteModal);
        deleteModal.addEventListener('click', (e) => { if (e.target === deleteModal) hideDeleteModal(); });
        modalDeleteBtn.addEventListener('click', () => {
            if (pendingDeleteSessionId) confirmDeleteSession(pendingDeleteSessionId);
            hideDeleteModal();
        });

        async function confirmDeleteSession(sessionId) {
            sessionsCache = sessionsCache.filter(s => s.session_id !== sessionId);
            renderSessions(sessionsCache);
            if (currentSessionId === sessionId) startNewChat();

            try {
                const url = new URL(`/delete_chat/${sessionId}`, window.location.origin);
                url.searchParams.append('username', currentUsername);
                await fetch(url, { method: 'DELETE' });
            } catch (e) {
                console.error('Error deleting session:', e);
            }
        }

        // ==================== SIDEBAR: LOAD A SESSION ====================
        async function loadSession(sessionId) {
            currentSessionId = sessionId;

            // Highlight active
            document.querySelectorAll('[data-session-id]').forEach(el => {
                el.classList.toggle('bg-white/[0.08]', el.dataset.sessionId === sessionId);
                el.classList.toggle('hover:bg-white/[0.05]', el.dataset.sessionId !== sessionId);
            });

            transitionToChatState();
            chatContainer.innerHTML = '';

            try {
                const url = new URL(`/get_history/${sessionId}`, window.location.origin);
                url.searchParams.append('username', currentUsername);
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed');
                const messages = await resp.json();
                messages.forEach(msg => addMessageToChat(msg.role === 'user' ? 'user' : 'bot', msg.content));
                scrollToBottom();
            } catch (e) {
                console.error('Error loading session:', e);
                addMessageToChat('bot', 'Error loading conversation history.');
            }
        }

        // ==================== SIDEBAR: UPSERT SESSION ====================
        function upsertSessionInSidebar(sessionId, title) {
            const existing = sessionsCache.find(s => s.session_id === sessionId);
            if (existing) {
                existing.last_active = new Date().toISOString();
                existing.title = title || existing.title;
            } else {
                sessionsCache.unshift({ session_id: sessionId, title: title || 'New Chat', last_active: new Date().toISOString() });
            }
            sessionsCache.sort((a, b) => new Date(b.last_active) - new Date(a.last_active));
            renderSessions(sessionsCache);
        }

        // ==================== UI STATE TRANSITIONS ====================
        function transitionToChatState() {
            if (!hasStarted) {
                hasStarted = true;
                heroText.style.opacity = '0';
                inputWrapper.classList.remove('items-center', 'absolute', 'inset-0');
                inputWrapper.classList.add('absolute', 'bottom-0', 'left-0', 'right-0', 'pb-8', 'z-20');
                chatContainer.classList.remove('opacity-0');
                footerText.classList.remove('opacity-0');
                setTimeout(() => { heroSection.style.display = 'none'; }, 500);
            }
        }

        function resetToHeroState() {
            hasStarted = false;
            chatContainer.innerHTML = '';
            chatContainer.classList.add('opacity-0');
            footerText.classList.add('opacity-0');
            heroSection.style.display = '';
            heroText.style.opacity = '1';
            inputWrapper.classList.remove('absolute', 'bottom-0', 'left-0', 'right-0', 'pb-8', 'z-20');
            inputWrapper.classList.add('items-center', 'absolute', 'inset-0');
            userInput.value = '';
        }

        function startNewChat() {
            currentSessionId = null;
            resetToHeroState();
            document.querySelectorAll('[data-session-id]').forEach(el => {
                el.classList.remove('bg-white/[0.08]');
                el.classList.add('hover:bg-white/[0.05]');
            });
            userInput.focus();
        }

        // ==================== SCROLL FIX ====================
        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // ==================== SEND MESSAGE ====================
        async function handleMessage(event) {
            event.preventDefault();
            const message = userInput.value.trim();
            
            if (!message) {
                console.warn('Cannot send empty message');
                return;
            }
            
            if (message.length > 400) {
                console.warn('Message too long');
                return;
            }

            const isNewSession = !currentSessionId;
            if (isNewSession) currentSessionId = generateUUID();

            transitionToChatState();
            addMessageToChat('user', message);
            userInput.value = '';
            updateCharCount();

            addLoadingIndicator();
            const startTime = Date.now();

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_input: message, session_id: currentSessionId, username: currentUsername })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 429) {
                        removeLoadingIndicator();
                        addMessageToChat('bot', `⏰ ${errorData.detail}`);
                        return;
                    }
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const responseTime = ((Date.now() - startTime) / 1000).toFixed(2);

                if (data.session_id) currentSessionId = data.session_id;

                removeLoadingIndicator();
                addMessageToChat('bot', data.response || "No response received.", responseTime);

                loadRemainingMessages();

                const title = message.length > 60 ? message.substring(0, 60) : message;
                upsertSessionInSidebar(currentSessionId, isNewSession ? title : null);
            } catch (error) {
                removeLoadingIndicator();
                addMessageToChat('bot', `Error: ${error.message}. Please check the console.`);
                console.error('Chat API Error:', error);
            }
        }

        // ==================== MESSAGE RENDERING ====================
        function addMessageToChat(role, text, responseTime = null) {
            const isUser = role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} group/msg`;

            const container = document.createElement('div');
            container.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[90%]`;

            const bubble = document.createElement('div');
            if (isUser) {
                bubble.className = 'bg-[#f4f2eb] text-stone-900 px-5 py-3 rounded-2xl leading-relaxed';
                bubble.innerText = text;
            } else {
                bubble.className = 'text-stone-800 py-3 leading-relaxed font-normal markdown-content';
                bubble.innerHTML = marked.parse(text);

                // Syntax highlighting
                bubble.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));

                // Copy buttons on code blocks
                bubble.querySelectorAll('pre').forEach(pre => {
                    const btn = document.createElement('button');
                    btn.className = 'absolute top-2 right-2 bg-white/10 border border-white/20 rounded-md px-2 py-1 cursor-pointer opacity-0 hover:bg-white/20 transition-all duration-200 text-[#d4d4d4] text-xs';
                    btn.innerHTML = clipboardIcon;

                    // Show on hover
                    pre.addEventListener('mouseenter', () => btn.style.opacity = '1');
                    pre.addEventListener('mouseleave', () => btn.style.opacity = '0');

                    btn.addEventListener('click', () => {
                        navigator.clipboard.writeText(pre.querySelector('code').textContent);
                        btn.innerHTML = checkIcon;
                        setTimeout(() => { btn.innerHTML = clipboardIcon; }, 1500);
                    });
                    pre.appendChild(btn);
                });
            }

            container.appendChild(bubble);

            // Action buttons
            const actions = document.createElement('div');
            actions.className = 'flex gap-1 mt-2 opacity-0 group-hover/msg:opacity-100 transition-opacity duration-200';

            if (isUser) {
                actions.innerHTML = `<button class="action-copy border border-stone-200 rounded-md px-2 py-1 text-stone-400 hover:bg-stone-100 hover:border-stone-300 transition-all text-sm cursor-pointer">${clipboardIcon}</button>`;
            } else {
                actions.innerHTML = `
                    <button class="action-copy border border-stone-200 rounded-md px-2 py-1 text-stone-400 hover:bg-stone-100 hover:border-stone-300 transition-all text-sm cursor-pointer">${clipboardIcon}</button>
                    <button class="action-like border border-stone-200 rounded-md px-2 py-1 text-stone-400 hover:bg-stone-100 hover:border-stone-300 transition-all text-sm cursor-pointer">${thumbUpIcon}</button>
                    <button class="action-dislike border border-stone-200 rounded-md px-2 py-1 text-stone-400 hover:bg-stone-100 hover:border-stone-300 transition-all text-sm cursor-pointer">${thumbDownIcon}</button>
                `;
            }

            // Copy message text
            actions.querySelector('.action-copy').addEventListener('click', function () {
                navigator.clipboard.writeText(text);
                this.innerHTML = checkIcon;
                setTimeout(() => { this.innerHTML = clipboardIcon; }, 1500);
            });

            // Like / Dislike toggles
            if (!isUser) {
                const likeBtn = actions.querySelector('.action-like');
                const dislikeBtn = actions.querySelector('.action-dislike');
                likeBtn.addEventListener('click', () => {
                    const on = likeBtn.classList.toggle('text-green-500'); likeBtn.classList.toggle('border-green-500', on); likeBtn.classList.toggle('bg-green-50', on);
                    dislikeBtn.classList.remove('text-red-500', 'border-red-500', 'bg-red-50');
                });
                dislikeBtn.addEventListener('click', () => {
                    const on = dislikeBtn.classList.toggle('text-red-500'); dislikeBtn.classList.toggle('border-red-500', on); dislikeBtn.classList.toggle('bg-red-50', on);
                    likeBtn.classList.remove('text-green-500', 'border-green-500', 'bg-green-50');
                });
            }

            container.appendChild(actions);

            // Response time
            if (!isUser && responseTime) {
                const time = document.createElement('div');
                time.className = 'text-xs text-stone-400 mt-2 text-right';
                time.textContent = `${responseTime}s`;
                container.appendChild(time);
            }

            wrapper.appendChild(container);
            chatContainer.appendChild(wrapper);
            scrollToBottom();
        }

        // ==================== LOADING INDICATOR ====================
        function addLoadingIndicator() {
            const div = document.createElement('div');
            div.id = 'loading-bubble';
            div.className = 'flex w-full mb-6 justify-start';
            div.innerHTML = '<div class="text-stone-400 py-2 animate-pulse">Thinking...</div>';
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function removeLoadingIndicator() {
            document.getElementById('loading-bubble')?.remove();
        }

        // ==================== SVG ICON CONSTANTS ====================
        const clipboardIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184"/></svg>`;
        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>`;
        const thumbUpIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5.004 9.5H5.25m.5 1.5v8.5"/></svg>`;
        const thumbDownIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.923 1.227h-.24"/></svg>`;

        // ==================== SIDEBAR TOGGLE ====================
        sidebarToggle.addEventListener('click', () => {
            sidebarExpanded = !sidebarExpanded;
            if (sidebarExpanded) {
                sidebar.style.width = '280px';
                mainContent.style.marginLeft = '280px';
                sidebarContent.style.opacity = '1';
                chatHistoryEl.style.opacity = '1';
            } else {
                sidebar.style.width = '60px';
                mainContent.style.marginLeft = '60px';
                sidebarContent.style.opacity = '0';
                chatHistoryEl.style.opacity = '0';
            }
        });

        // ==================== AUTH HANDLERS ====================
        loginForm.addEventListener('submit', handleLoginSubmit);
        logoutBtn.addEventListener('click', logout);

        // ==================== CHARACTER COUNTER ====================
        userInput.addEventListener('input', updateCharCount);

        // ==================== NEW CHAT ====================
        newChatBtn.addEventListener('click', () => startNewChat());

        // ==================== SEARCH ====================
        document.getElementById('search-threads').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            renderSessions(q ? sessionsCache.filter(s => s.title.toLowerCase().includes(q)) : sessionsCache);
        });

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                loadSessions();
                userInput.focus();
            }
        });
    </script>
</body>

</html>